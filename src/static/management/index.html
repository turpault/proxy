<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Proxy Server Management</title>
  <!-- ECharts CDN for world map heatmap -->
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/extension/dataTool.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/extension/bmap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.0/dist/extension/world.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background-color: #f5f7fa;
      color: #2d3748;
      line-height: 1.6;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* Tab bar styles */
    .tab-bar {
      display: flex;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border-radius: 8px 8px 0 0;
      overflow: hidden;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0,0,0,0.08);
    }
    
    .tab {
      flex: 1;
      padding: 1.2rem 0;
      text-align: center;
      color: #fff;
      font-size: 1.2rem;
      font-weight: 600;
      cursor: pointer;
      background: none;
      border: none;
      outline: none;
      transition: background 0.2s, color 0.2s;
    }
    
    .tab.active {
      background: rgba(255,255,255,0.15);
      color: #fff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    
    .tab:not(.active):hover {
      background: rgba(255,255,255,0.08);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 2.5rem;
      margin-bottom: 0.5rem;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1rem;
    }

    .connection-status {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-weight: 500;
      font-size: 0.9rem;
      display: inline-block;
    }

    .connection-status.connected {
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .connection-status.disconnected {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .status-cards, .stats-overview {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }

    .card, .stat-card {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    .card h3, .stat-card h4 {
      color: #4a5568;
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .card .value, .stat-card .value {
      font-size: 2rem;
      font-weight: bold;
      color: #2d3748;
    }

    .refresh-btn {
      background: #4299e1;
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      margin-bottom: 2rem;
      transition: background-color 0.2s;
    }

    .refresh-btn:hover {
      background: #3182ce;
    }

    .refresh-btn:disabled {
      background: #a0aec0;
      cursor: not-allowed;
    }

    .processes-section, .routes-section, .certificates-section {
      background: white;
      border-radius: 8px;
      padding: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      margin-bottom: 2rem;
    }

    .processes-section h2, .routes-section h2, .certificates-section h2 {
      color: #2d3748;
      margin-bottom: 0.5rem;
      font-size: 1.5rem;
    }

    .section-description {
      color: #718096;
      font-size: 0.95rem;
      margin-bottom: 1.5rem;
      font-style: italic;
    }

    .process {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      margin-bottom: 1rem;
      overflow: hidden;
      transition: box-shadow 0.2s;
    }

    .process:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .process-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
      min-height: 4rem;
      gap: 1rem;
      transition: all 0.2s ease;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      position: relative;
    }

    .process-header:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }

    .process-header::after {
      content: 'â–¼';
      position: absolute;
      right: 1rem;
      top: 50%;
      transform: translateY(-50%);
      color: #718096;
      font-size: 0.8rem;
      transition: transform 0.2s ease;
    }

    .process-header.expanded::after {
      transform: translateY(-50%) rotate(180deg);
    }

    .process-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      min-height: 3rem;
    }

    .process-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #2d3748;
      margin-bottom: 0.5rem;
      line-height: 1.2;
    }

    .process-details {
      font-size: 0.9rem;
      color: #718096;
      margin-top: 0.25rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      align-items: center;
      justify-content: flex-start;
    }

    .process-details span {
      white-space: nowrap;
      min-width: fit-content;
      height: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.25rem 0.5rem;
      background: #f8f9fa;
      border-radius: 4px;
      border: 1px solid #e9ecef;
      font-weight: 500;
      font-size: 0.85rem;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      line-height: 1;
      text-align: center;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 1rem;
    }

    .process-details span.success {
      background: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }

    .process-details span.warning {
      background: #fff3cd;
      border-color: #ffeaa7;
      color: #856404;
    }

    .process-details span.error {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }

    .process-status {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-badge {
      padding: 0.25rem 0.75rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: bold;
      text-transform: uppercase;
    }

    .status-running {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-stopped {
      background: #fed7d7;
      color: #742a2a;
    }

    .status-warning {
      background: #fef5e7;
      color: #744210;
    }

    .status-error {
      background: #fed7d7;
      color: #742a2a;
    }

    .process-actions {
      display: flex;
      gap: 0.5rem;
      align-items: center;
      min-height: 3rem;
      justify-content: flex-end;
    }

    .btn {
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.9rem;
      transition: all 0.2s;
      height: 2.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 80px;
      white-space: nowrap;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .btn-start {
      background: #48bb78;
      color: white;
    }

    .btn-start:hover:not(:disabled) {
      background: #38a169;
    }

    .btn-stop {
      background: #f56565;
      color: white;
    }

    .btn-stop:hover:not(:disabled) {
      background: #e53e3e;
    }

    .btn-restart {
      background: #ed8936;
      color: white;
    }

    .btn-restart:hover:not(:disabled) {
      background: #dd6b20;
    }

    .btn-logs {
      background: #4299e1;
      color: white;
    }

    .btn-logs:hover {
      background: #3182ce;
    }

    .process-body {
      padding: 1rem;
      display: none;
    }

    .process-body.expanded {
      display: block;
    }

    .process-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .metric {
      text-align: center;
    }

    .metric-label {
      font-size: 0.8rem;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .metric-value {
      font-size: 1.2rem;
      font-weight: bold;
      padding: 1rem;
      color: #2d3748;
    }

    .metric-value.warning {
      color: #d69e2e;
    }

    .metric-value.error {
      color: #e53e3e;
    }

    .metric-value.success {
      color: #38a169;
    }

    .restart-history {
      background: #f7fafc;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
    }

    .restart-history h4 {
      color: #2d3748;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .restart-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
      border-bottom: 1px solid #e2e8f0;
    }

    .restart-item:last-child {
      border-bottom: none;
    }

    .restart-time {
      font-size: 0.9rem;
      color: #4a5568;
    }

    .restart-count {
      font-weight: bold;
      color: #2d3748;
    }

    .logs-container {
      background: #1a202c;
      color: #e2e8f0;
      border-radius: 6px;
      padding: 1rem;
      max-height: 310px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.9rem;
      line-height: 1.4;
      position: relative;
    }

    .logs-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #4a5568;
    }

    .logs-title {
      font-weight: bold;
      color: #e2e8f0;
    }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      color: #48bb78;
    }

    .live-dot {
      width: 8px;
      height: 8px;
      background: #48bb78;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .log-line {
      margin-bottom: 0.25rem;
      word-wrap: break-word;
      padding: 0.1rem 0;
    }

    .log-line:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .logs-content {
      max-height: 250px;
      overflow-y: auto;
      padding-right: 0.5rem;
    }

    .logs-content::-webkit-scrollbar {
      width: 6px;
    }

    .logs-content::-webkit-scrollbar-track {
      background: #2d3748;
      border-radius: 3px;
    }

    .logs-content::-webkit-scrollbar-thumb {
      background: #4a5568;
      border-radius: 3px;
    }

    .logs-content::-webkit-scrollbar-thumb:hover {
      background: #718096;
    }

    /* Time filter styles */
    .time-filter {
      background: white;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    .time-filter h3 {
      margin-bottom: 1rem;
      color: #2d3748;
    }

    .filter-buttons {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }

    .filter-btn {
      background: #e2e8f0;
      color: #4a5568;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: all 0.2s;
    }

    .filter-btn.active {
      background: #4299e1;
      color: white;
    }

    .filter-btn:hover {
      background: #4299e1;
      color: white;
    }

    /* Routes table styles */
    .routes-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1rem;
    }

    .routes-table th,
    .routes-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
    }

    .routes-table th {
      background: #f7fafc;
      font-weight: 600;
      color: #4a5568;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .routes-table tr:hover {
      background: #f7fafc;
    }

    .route-domain {
      font-weight: 600;
      color: #2d3748;
    }

    .route-target {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.9rem;
      color: #4a5568;
    }

    .request-count {
      font-weight: 600;
      color: #2d3748;
    }

    .geolocation {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .country-flag {
      width: 20px;
      height: 15px;
      border-radius: 2px;
      object-fit: cover;
    }

    .country-name {
      font-size: 0.9rem;
      color: #4a5568;
    }

    /* Certificate styles */
    .certificate-card {
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 1.5rem;
      margin-bottom: 1rem;
      background: #f7fafc;
    }

    .certificate-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }

    .certificate-name {
      font-weight: 600;
      color: #2d3748;
      font-size: 1.1rem;
    }

    .certificate-status {
      padding: 0.5rem 1rem;
      border-radius: 4px;
      font-weight: 500;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .certificate-status.valid {
      background: rgba(34, 197, 94, 0.1);
      color: #16a34a;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .certificate-status.expired {
      background: rgba(239, 68, 68, 0.1);
      color: #dc2626;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .certificate-status.expiring-soon {
      background: rgba(245, 158, 11, 0.1);
      color: #d97706;
      border: 1px solid rgba(245, 158, 11, 0.2);
    }

    .certificate-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
    }

    .certificate-detail {
      display: flex;
      flex-direction: column;
    }

    .certificate-detail-label {
      font-weight: 500;
      color: #4a5568;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 0.25rem;
    }

    .certificate-detail-value {
      color: #2d3748;
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.9rem;
    }

    .letsencrypt-info {
      background: #f7fafc;
      border-radius: 6px;
      padding: 1rem;
      margin-bottom: 1rem;
      border: 1px solid #e2e8f0;
    }

    .letsencrypt-info h4 {
      color: #2d3748;
      margin-bottom: 0.5rem;
      font-size: 1rem;
    }

    .letsencrypt-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      font-size: 0.9rem;
    }

    .letsencrypt-detail {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.5rem 0;
    }

    .letsencrypt-detail .label {
      color: #4a5568;
      font-weight: 500;
    }

    .letsencrypt-detail .value {
      color: #2d3748;
      font-weight: 600;
    }

    /* Geolocation heatmap */
    #geo-heatmap {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      margin-bottom: 2rem;
    }

    /* Utility classes */
    .loading {
      text-align: center;
      color: #718096;
      font-style: italic;
    }

    .error {
      background: #fed7d7;
      color: #742a2a;
      padding: 1rem;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .success {
      background: #c6f6d5;
      color: #22543d;
      border-radius: 6px;
      margin-bottom: 1rem;
    }

    .notification {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 1rem 1.5rem;
      border-radius: 6px;
      color: white;
      font-weight: bold;
      z-index: 1000;
      transform: translateX(400px);
      transition: transform 0.3s ease;
    }

    .notification.show {
      transform: translateX(0);
    }

    .notification.success {
      background: #48bb78;
    }

    .notification.error {
      background: #f56565;
    }

    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }

      .header h1 {
        font-size: 2rem;
      }

      .process-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
        min-height: auto;
        padding: 0.75rem;
      }

      .process-info {
        min-height: auto;
        width: 100%;
      }

      .process-actions {
        flex-wrap: wrap;
        gap: 0.5rem;
        width: 100%;
        justify-content: flex-start;
        min-height: auto;
      }

      .btn {
        height: 2.25rem;
        min-width: 70px;
        font-size: 0.85rem;
        padding: 0.4rem 0.8rem;
      }

      .process-details {
        flex-direction: column;
        gap: 0.5rem;
        align-items: flex-start;
        justify-content: flex-start;
      }

      .process-details span {
        font-size: 0.85rem;
        height: 1.4rem;
        padding: 0.2rem 0.4rem;
        width: 100%;
        justify-content: flex-start;
      }

      .routes-table {
        font-size: 0.8rem;
      }

      .routes-table th,
      .routes-table td {
        padding: 0.5rem;
      }

      .letsencrypt-details {
        grid-template-columns: 1fr;
        gap: 0.5rem;
      }

      .letsencrypt-detail {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.25rem;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="tab-bar">
      <button class="tab active" id="tab-processes" onclick="showTab('processes')">ðŸš€ Processes</button>
      <button class="tab" id="tab-statistics" onclick="showTab('statistics')">ðŸ“Š Statistics</button>
      <button class="tab" id="tab-certificates" onclick="showTab('certificates')">ðŸ”’ Certificates</button>
    </div>
    
    <!-- Processes Tab -->
    <div id="content-processes" class="tab-content active">
      <div class="header">
        <h1>ðŸš€ Proxy Server Management</h1>
        <p>Monitor and control your managed processes</p>
        <div id="connection-status" class="connection-status">ðŸŸ¡ Connecting...</div>
      </div>

      <div class="status-cards">
        <div class="card">
          <h3>Total Processes</h3>
          <div class="value" id="processes-count">-</div>
        </div>
        <div class="card">
          <h3>Active Processes</h3>
          <div class="value" id="running-count">-</div>
        </div>
        <div class="card">
          <h3>Inactive Processes</h3>
          <div class="value" id="stopped-count">-</div>
        </div>
        <div class="card">
          <h3>Server Uptime</h3>
          <div class="value" id="uptime">-</div>
        </div>
        <div class="card">
          <h3>Last Updated</h3>
          <div class="value" id="last-updated">-</div>
        </div>
      </div>

      <div class="processes-section">
        <h2>All Managed Processes</h2>
        <p class="section-description">Showing all configured processes including running and stopped instances</p>
        <div id="processes-container">
          <div class="loading">Loading processes...</div>
        </div>
      </div>
    </div>

    <!-- Statistics Tab -->
    <div id="content-statistics" class="tab-content">
      <div class="header">
        <h1>ðŸ“Š HTTP Service Statistics</h1>
        <p>Monitor proxy traffic, routes, and geolocation data</p>
      </div>

      <!-- World map heatmap for geolocation statistics -->
      <div id="geo-heatmap" style="width:100%;height:500px;"></div>

      <div class="time-filter">
        <h3>Time Period</h3>
        <div class="filter-buttons">
          <button class="filter-btn active" onclick="setTimeFilter('1h')">1 Hour</button>
          <button class="filter-btn" onclick="setTimeFilter('24h')">24 Hours</button>
          <button class="filter-btn" onclick="setTimeFilter('7d')">7 Days</button>
          <button class="filter-btn" onclick="setTimeFilter('30d')">30 Days</button>
        </div>
      </div>

      <div class="stats-overview">
        <div class="stat-card">
          <h4>Total Requests</h4>
          <div class="value" id="totalRequests">-</div>
        </div>
        <div class="stat-card">
          <h4>Unique IPs</h4>
          <div class="value" id="uniqueIPs">-</div>
        </div>
        <div class="stat-card">
          <h4>Active Routes</h4>
          <div class="value" id="activeRoutes">-</div>
        </div>
        <div class="stat-card">
          <h4>Countries</h4>
          <div class="value" id="uniqueCountries">-</div>
        </div>
        <div class="stat-card">
          <h4>Avg Response Time</h4>
          <div class="value" id="avgResponseTime">-</div>
        </div>
      </div>

      <div class="routes-section">
        <h2>Route Statistics</h2>
        <div id="routesTable">
          <div class="loading">Loading route statistics...</div>
        </div>
      </div>
    </div>

    <!-- Certificates Tab -->
    <div id="content-certificates" class="tab-content">
      <div class="header">
        <h1>ðŸ”’ SSL Certificates</h1>
        <p>Manage SSL certificates and Let's Encrypt configuration</p>
      </div>

      <div class="stats-overview">
        <div class="stat-card">
          <h4>SSL Certificates</h4>
          <div class="value" id="certificates-count">-</div>
        </div>
        <div class="stat-card">
          <h4>Valid Certificates</h4>
          <div class="value" id="valid-certificates">-</div>
        </div>
        <div class="stat-card">
          <h4>Expiring Soon</h4>
          <div class="value" id="expiring-soon">-</div>
        </div>
        <div class="stat-card">
          <h4>Expired</h4>
          <div class="value" id="expired-certificates">-</div>
        </div>
        <div class="stat-card">
          <h4>Let's Encrypt</h4>
          <div class="value" id="letsencrypt-status">-</div>
        </div>
      </div>

      <div class="certificates-section">
        <h2>SSL Certificates</h2>
        <p class="section-description">Let's Encrypt certificate status and expiration information</p>
        <button onclick="loadCertificates()" class="refresh-btn">ðŸ”„ Refresh Certificates</button>
        <div id="certificates-container">
          <div class="loading">Loading certificates...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let ws = null;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    const reconnectDelay = 2000;
    let processesData = [];
    let statusData = {};
    let liveUpdateIntervals = {};
    let currentTimeFilter = '24h';
    let geoHeatmapChart = null;
    let geoHeatmapLoaded = false;
    let certificatesData = {};

    // Tab switching logic
    function showTab(tab) {
      // Hide all tabs
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      // Show selected tab
      document.getElementById(`tab-${tab}`).classList.add('active');
      document.getElementById(`content-${tab}`).classList.add('active');
      
      // Load data for specific tabs
      if (tab === 'statistics') {
        if (!geoHeatmapLoaded) {
          renderGeoHeatmap();
        }
        loadStatistics();
      } else if (tab === 'certificates') {
        loadCertificates();
      }
    }

    // WebSocket connection management
    function connectWebSocket() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const wsUrl = `${protocol}//${window.location.host}/ws`;
      
      ws = new WebSocket(wsUrl);
      
      ws.onopen = function() {
        console.log('WebSocket connected');
        reconnectAttempts = 0;
        updateConnectionStatus(true);
      };
      
      ws.onmessage = function(event) {
        try {
          const message = JSON.parse(event.data);
          handleWebSocketMessage(message);
        } catch (error) {
          console.error('Failed to parse WebSocket message:', error);
        }
      };
      
      ws.onclose = function() {
        console.log('WebSocket disconnected');
        updateConnectionStatus(false);
        
        // Attempt to reconnect
        if (reconnectAttempts < maxReconnectAttempts) {
          reconnectAttempts++;
          console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
          setTimeout(connectWebSocket, reconnectDelay);
        } else {
          console.error('Max reconnection attempts reached');
          showNotification('WebSocket connection lost. Please refresh the page.', 'error');
        }
      };
      
      ws.onerror = function(error) {
        console.error('WebSocket error:', error);
      };
    }

    function updateConnectionStatus(connected) {
      const statusElement = document.getElementById('connection-status');
      if (statusElement) {
        statusElement.textContent = connected ? 'ðŸŸ¢ Connected' : 'ðŸ”´ Disconnected';
        statusElement.className = connected ? 'connected' : 'disconnected';
      }
    }

    function handleWebSocketMessage(message) {
      switch (message.type) {
        case 'processes':
          processesData = message.data;
          updateProcessesDisplay();
          break;
        case 'status':
          statusData = message.data;
          updateStatusDisplay();
          break;
        case 'logs':
          updateProcessLogs(message.data.processId, message.data.logs);
          break;
        case 'error':
          console.error('WebSocket error:', message.data);
          showNotification('WebSocket error: ' + message.data.message, 'error');
          break;
        case 'pong':
          // Handle ping/pong for connection health
          break;
        default:
          console.warn('Unknown WebSocket message type:', message.type);
      }
    }

    function requestLogs(processId) {
      if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
          type: 'request_logs',
          processId: processId
        }));
      }
    }

    // Update status display
    function updateStatusDisplay() {
      const processesCount = statusData.processes?.length || 0;
      const runningCount = statusData.processes?.filter(p => p.status === 'running').length || 0;
      const stoppedCount = processesCount - runningCount;
      const uptime = statusData.uptime || 0;
      const timestamp = statusData.timestamp ? new Date(statusData.timestamp).toLocaleString() : 'N/A';

      document.getElementById('processes-count').textContent = processesCount;
      document.getElementById('running-count').textContent = runningCount;
      document.getElementById('stopped-count').textContent = stoppedCount;
      document.getElementById('uptime').textContent = formatUptime(uptime * 1000);
      document.getElementById('last-updated').textContent = timestamp;
    }

    // Update processes display
    function updateProcessesDisplay() {
      const container = document.getElementById('processes-container');
      
      if (!processesData || processesData.length === 0) {
        container.innerHTML = '<div class="no-processes">No processes configured</div>';
        return;
      }

      container.innerHTML = processesData.map(process => {
        const statusClass = process.status === 'running' ? 'success' : 'error';
        const statusText = process.status === 'running' ? 'Running' : 'Stopped';
        
        return `
          <div class="process">
            <div class="process-header" onclick="toggleProcess('${process.id}')">
              <div class="process-info">
                <div class="process-name">${process.name || process.id}</div>
                <div class="process-details">
                  <span class="status-badge ${statusClass}">${statusText}</span>
                  ${process.pid ? `<span>PID: ${process.pid}</span>` : ''}
                  ${process.port ? `<span>Port: ${process.port}</span>` : ''}
                  <span>Restarts: ${process.restartAttempts || 0}</span>
                  <span class="health-badge ${process.healthFailures > 0 ? 'warning' : 'success'}">Health: ${process.healthFailures || 0}</span>
                </div>
              </div>
              <div class="process-actions">
                <button onclick="event.stopPropagation(); startProcess('${process.id}')" class="btn btn-start" ${process.status === 'running' ? 'disabled' : ''}>
                  Start
                </button>
                <button onclick="event.stopPropagation(); stopProcess('${process.id}')" class="btn btn-stop" ${process.status !== 'running' ? 'disabled' : ''}>
                  Stop
                </button>
                <button onclick="event.stopPropagation(); restartProcess('${process.id}')" class="btn btn-restart">
                  Restart
                </button>
                <button onclick="event.stopPropagation(); showLogs('${process.id}')" class="btn btn-logs">
                  Logs
                </button>
              </div>
            </div>
            <div class="process-body" id="process-${process.id}">
              <div class="process-metrics">
                <div class="metric">
                  <div class="metric-label">Start Time</div>
                  <div class="metric-value">${process.startTime ? new Date(process.startTime).toLocaleString() : 'N/A'}</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Last Restart</div>
                  <div class="metric-value">${process.lastRestartTime ? new Date(process.lastRestartTime).toLocaleString() : 'N/A'}</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Uptime</div>
                  <div class="metric-value">${process.uptime ? formatUptime(process.uptime * 1000) : 'N/A'}</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Restart Count</div>
                  <div class="metric-value ${getRestartCountClass(process.restartAttempts || 0)}">${process.restartAttempts || 0}</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Health Failures</div>
                  <div class="metric-value ${getRestartCountClass(process.healthFailures || 0)}">${process.healthFailures || 0}</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Process State</div>
                  <div class="metric-value ${process.status === 'running' ? 'success' : 'error'}">${process.status === 'running' ? 'Active' : 'Inactive'}</div>
                </div>
              </div>
              
              <div class="restart-history">
                <h4>ðŸ”„ Restart History</h4>
                <div class="restart-item">
                  <span class="restart-time">Current Session</span>
                  <span class="restart-count">${process.restartAttempts || 0} restarts</span>
                </div>
                ${process.lastRestartTime ? `
                <div class="restart-item">
                  <span class="restart-time">Last Restart</span>
                  <span class="restart-count">${new Date(process.lastRestartTime).toLocaleString()}</span>
                </div>
                ` : ''}
                ${process.isReconnected ? `
                <div class="restart-item">
                  <span class="restart-time">Process Reconnected</span>
                  <span class="restart-count">Existing PID: ${process.pid}</span>
                </div>
                ` : ''}
              </div>

              <div class="process-metrics">
                <div class="metric">
                  <div class="metric-label">Log File</div>
                  <div class="metric-value" style="font-size: 0.8rem;">${process.logFile || 'N/A'}</div>
                </div>
                <div class="metric">
                  <div class="metric-label">PID File</div>
                  <div class="metric-value" style="font-size: 0.8rem;">${process.pidFile || 'N/A'}</div>
                </div>
              </div>
              
              <div class="logs-container" id="logs-${process.id}">
                <div class="loading">Click "Logs" to load recent log entries</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Toggle process details
    function toggleProcess(processId) {
      const processBody = document.getElementById(`process-${processId}`);
      const processHeader = processBody?.parentElement?.querySelector('.process-header');
      
      if (processBody) {
        const isExpanding = !processBody.classList.contains('expanded');
        processBody.classList.toggle('expanded');
        if (processHeader) {
          processHeader.classList.toggle('expanded');
        }
        
        // Automatically load logs when expanding
        if (isExpanding) {
          requestLogs(processId);
          startLiveLogUpdates(processId);
        } else {
          stopLiveLogUpdates(processId);
        }
      }
    }

    // Process control functions
    async function startProcess(processId) {
      await performProcessAction(processId, 'start');
    }

    async function stopProcess(processId) {
      await performProcessAction(processId, 'stop');
    }

    async function restartProcess(processId) {
      await performProcessAction(processId, 'restart');
    }

    async function performProcessAction(processId, action) {
      try {
        const response = await fetch(`/api/processes/${processId}/${action}`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          showNotification(`Process ${processId} ${action}ed successfully`, 'success');
          // WebSocket will automatically update the display
        } else {
          showNotification(`Failed to ${action} process: ` + data.error, 'error');
        }
      } catch (error) {
        showNotification(`Failed to ${action} process: ` + error.message, 'error');
      }
    }

    // Update process logs via WebSocket
    function updateProcessLogs(processId, logs) {
      const logsContainer = document.getElementById(`logs-${processId}`);
      if (!logsContainer) {
        return;
      }

      if (!logs || logs.length === 0) {
        logsContainer.innerHTML = `
          <div class="logs-header">
            <div class="logs-title">Process Logs</div>
            <div class="live-indicator">
              <div class="live-dot"></div>
              <span>Live</span>
            </div>
          </div>
          <div class="loading">No logs available</div>
        `;
        return;
      }

      const logLines = logs.map(log => {
        // Logs are already parsed as HTML from the server
        return `<div class="log-line">${log}</div>`;
      }).join('');

      logsContainer.innerHTML = `
        <div class="logs-header">
          <div class="logs-title">Process Logs (${logs.length} lines)</div>
          <div class="live-indicator">
            <div class="live-dot"></div>
            <span>Live</span>
          </div>
        </div>
        <div class="logs-content">
          ${logLines}
        </div>
      `;
      
      // Scroll to bottom for new logs
      const logsContent = logsContainer.querySelector('.logs-content');
      if (logsContent) {
        logsContent.scrollTop = logsContent.scrollHeight;
      }
    }

    // Start live log updates for a process
    function startLiveLogUpdates(processId) {
      // Stop any existing interval for this process
      stopLiveLogUpdates(processId);
      
      // Request logs every 5 seconds via WebSocket
      liveUpdateIntervals[processId] = setInterval(() => {
        requestLogs(processId);
      }, 5000);
    }

    // Stop live log updates for a process
    function stopLiveLogUpdates(processId) {
      if (liveUpdateIntervals[processId]) {
        clearInterval(liveUpdateIntervals[processId]);
        delete liveUpdateIntervals[processId];
      }
    }

    // Show logs (now uses WebSocket)
    async function showLogs(processId) {
      // First expand the process details if not already expanded
      const processBody = document.getElementById(`process-${processId}`);
      const processHeader = processBody?.parentElement?.querySelector('.process-header');
      
      if (processBody && !processBody.classList.contains('expanded')) {
        processBody.classList.add('expanded');
        if (processHeader) {
          processHeader.classList.add('expanded');
        }
      }

      // Request logs via WebSocket and start live updates
      requestLogs(processId);
      startLiveLogUpdates(processId);
    }

    // Statistics functions
    function setTimeFilter(period) {
      currentTimeFilter = period;
      
      // Update active button
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      loadStatistics();
      if (geoHeatmapLoaded) {
        renderGeoHeatmap();
      }
    }

    async function loadStatistics() {
      try {
        const response = await fetch(`/api/statistics?period=${currentTimeFilter}`);
        const data = await response.json();
        
        if (data.success) {
          updateStatisticsDisplay(data.data);
        } else {
          console.error('Failed to load statistics:', data.error);
        }
      } catch (error) {
        console.error('Error loading statistics:', error);
      }
    }

    function updateStatisticsDisplay(data) {
      // Update overview cards
      document.getElementById('totalRequests').textContent = formatNumber(data.totalRequests || 0);
      document.getElementById('uniqueIPs').textContent = formatNumber(data.uniqueIPs || 0);
      document.getElementById('activeRoutes').textContent = (data.routes || []).length;
      document.getElementById('uniqueCountries').textContent = formatNumber(data.uniqueCountries || 0);
      document.getElementById('avgResponseTime').textContent = formatResponseTime(data.avgResponseTime || 0);
      
      // Update routes table
      const routesContainer = document.getElementById('routesTable');
      if (data.routes && data.routes.length > 0) {
        const routesHtml = `
          <table class="routes-table">
            <thead>
              <tr>
                <th>Domain</th>
                <th>Target</th>
                <th>Requests</th>
                <th>Top Countries</th>
                <th>Avg Response Time</th>
              </tr>
            </thead>
            <tbody>
              ${data.routes.map(route => `
                <tr>
                  <td class="route-domain">${route.domain}</td>
                  <td class="route-target">${route.target}</td>
                  <td class="request-count">${formatNumber(route.requestCount || route.requests || 0)}</td>
                  <td>
                    ${(route.topCountries || []).slice(0, 3).map(country => `
                      <div class="geolocation">
                        <img src="https://flagcdn.com/16x12/${country.countryCode?.toLowerCase() || 'xx'}.png" 
                             alt="${country.country}" 
                             class="country-flag"
                             onerror="this.style.display='none'">
                        <span class="country-name">${country.country} (${country.count})</span>
                      </div>
                    `).join('')}
                  </td>
                  <td>${formatResponseTime(route.avgResponseTime || 0)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
        routesContainer.innerHTML = routesHtml;
      } else {
        routesContainer.innerHTML = '<div class="loading">No route data available</div>';
      }
    }

    async function renderGeoHeatmap() {
      const container = document.getElementById('geo-heatmap');
      container.innerHTML = '';
      
      if (!window.echarts) {
        container.innerHTML = '<div style="color:#e53e3e;padding:2rem;text-align:center;">ECharts library not loaded</div>';
        return;
      }
      
      if (!geoHeatmapChart) {
        geoHeatmapChart = echarts.init(container);
      }
      
      geoHeatmapChart.showLoading('default', { text: 'Loading geolocation statistics...' });

      try {
        const res = await fetch(`/api/statistics?period=${currentTimeFilter}`);
        const data = await res.json();
        
        if (!data.success) {
          throw new Error('Failed to load statistics');
        }
        
        // Aggregate country counts from all routes
        const countryCounts = {};
        (data.data.routes || []).forEach(route => {
          (route.topCountries || []).forEach(c => {
            if (!c.country) return;
            countryCounts[c.country] = (countryCounts[c.country] || 0) + c.count;
          });
        });
        
        // Convert to ECharts format
        const mapData = Object.entries(countryCounts).map(([country, count]) => ({ 
          name: country, 
          value: count 
        }));
        
        geoHeatmapChart.setOption({
          title: {
            text: `Geolocation Heatmap (${currentTimeFilter})`,
            left: 'center',
            top: 10,
            textStyle: { fontSize: 20 }
          },
          tooltip: {
            trigger: 'item',
            formatter: params => `${params.name}: ${params.value || 0} requests`
          },
          visualMap: {
            min: 0,
            max: Math.max(10, ...mapData.map(d => d.value)),
            text: ['High','Low'],
            realtime: false,
            calculable: true,
            inRange: {
              color: ['#e0f3f8','#abd9e9','#74add1','#4575b4','#313695','#a50026']
            },
            left: 'left',
            bottom: 30
          },
          series: [{
            name: 'Requests',
            type: 'map',
            map: 'world',
            roam: true,
            emphasis: { label: { show: true } },
            data: mapData
          }]
        });
        
        geoHeatmapChart.hideLoading();
        geoHeatmapLoaded = true;
      } catch (err) {
        container.innerHTML = '<div style="color:#e53e3e;padding:2rem;text-align:center;">Failed to load geolocation statistics</div>';
      }
    }

    // Certificate functions
    async function loadCertificates() {
      try {
        const response = await fetch('/api/certificates');
        const data = await response.json();

        if (data.success) {
          certificatesData = data.data;
          updateCertificatesDisplay();
        } else {
          console.error('Failed to load certificates:', data.error);
        }
      } catch (error) {
        console.error('Failed to load certificates:', error);
      }
    }

    function updateCertificatesDisplay() {
      const { certificates, letsEncryptStatus } = certificatesData;

      // Update status cards
      document.getElementById('certificates-count').textContent = letsEncryptStatus.totalCertificates;
      document.getElementById('valid-certificates').textContent = letsEncryptStatus.validCertificates;
      document.getElementById('expiring-soon').textContent = letsEncryptStatus.expiringSoon;
      document.getElementById('expired-certificates').textContent = letsEncryptStatus.expired;
      
      const letsEncryptMode = letsEncryptStatus.staging ? 'Staging' : 'Production';
      document.getElementById('letsencrypt-status').textContent = letsEncryptMode;

      // Update certificates table
      const container = document.getElementById('certificates-container');
      
      if (!certificates || certificates.length === 0) {
        container.innerHTML = '<div class="no-data">No certificates found</div>';
        return;
      }

      const letsEncryptInfo = `
        <div class="letsencrypt-info">
          <h4>ðŸ”’ Let's Encrypt Configuration</h4>
          <div class="letsencrypt-details">
            <div class="letsencrypt-detail">
              <span class="label">Email:</span>
              <span class="value">${letsEncryptStatus.email}</span>
            </div>
            <div class="letsencrypt-detail">
              <span class="label">Environment:</span>
              <span class="value">${letsEncryptStatus.staging ? 'Staging' : 'Production'}</span>
            </div>
            <div class="letsencrypt-detail">
              <span class="label">Certificate Directory:</span>
              <span class="value">${letsEncryptStatus.certDir}</span>
            </div>
            <div class="letsencrypt-detail">
              <span class="label">Total Certificates:</span>
              <span class="value">${letsEncryptStatus.totalCertificates}</span>
            </div>
            <div class="letsencrypt-detail">
              <span class="label">Valid:</span>
              <span class="value">${letsEncryptStatus.validCertificates}</span>
            </div>
            <div class="letsencrypt-detail">
              <span class="label">Expiring Soon:</span>
              <span class="value">${letsEncryptStatus.expiringSoon}</span>
            </div>
            <div class="letsencrypt-detail">
              <span class="label">Expired:</span>
              <span class="value">${letsEncryptStatus.expired}</span>
            </div>
          </div>
        </div>
      `;

      const certificatesHtml = certificates.map(cert => {
        const now = new Date();
        const expiryDate = new Date(cert.expiresAt);
        const daysUntilExpiry = Math.ceil((expiryDate - now) / (1000 * 60 * 60 * 24));
        
        let status = 'valid';
        let statusText = 'Valid';
        
        if (expiryDate < now) {
          status = 'expired';
          statusText = 'Expired';
        } else if (daysUntilExpiry <= 30) {
          status = 'expiring-soon';
          statusText = `Expires in ${daysUntilExpiry} days`;
        }
        
        return `
          <div class="certificate-card">
            <div class="certificate-header">
              <div class="certificate-name">${cert.domain}</div>
              <div class="certificate-status ${status}">${statusText}</div>
            </div>
            <div class="certificate-details">
              <div class="certificate-detail">
                <div class="certificate-detail-label">Domain</div>
                <div class="certificate-detail-value">${cert.domain}</div>
              </div>
              <div class="certificate-detail">
                <div class="certificate-detail-label">Valid Until</div>
                <div class="certificate-detail-value">${new Date(cert.expiresAt).toLocaleString()}</div>
              </div>
              <div class="certificate-detail">
                <div class="certificate-detail-label">Days Until Expiry</div>
                <div class="certificate-detail-value">${daysUntilExpiry}</div>
              </div>
              <div class="certificate-detail">
                <div class="certificate-detail-label">Status</div>
                <div class="certificate-detail-value">${cert.isValid ? 'Valid' : 'Invalid'}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = letsEncryptInfo + certificatesHtml;
    }

    // Utility functions
    function formatUptime(milliseconds) {
      const seconds = Math.floor(milliseconds / 1000);
      const minutes = Math.floor(seconds / 60);
      const hours = Math.floor(minutes / 60);
      const days = Math.floor(hours / 24);

      if (days > 0) return `${days}d ${hours % 24}h`;
      if (hours > 0) return `${hours}h ${minutes % 60}m`;
      if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
      return `${seconds}s`;
    }

    function getRestartCountClass(count) {
      if (count === 0) return 'success';
      if (count <= 3) return 'warning';
      return 'error';
    }

    function formatNumber(num) {
      if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
      } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
      }
      return num.toString();
    }

    function formatResponseTime(ms) {
      if (ms < 1000) {
        return ms.toFixed(0) + 'ms';
      } else {
        return (ms / 1000).toFixed(2) + 's';
      }
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;

      document.body.appendChild(notification);

      setTimeout(() => notification.classList.add('show'), 100);
      setTimeout(() => {
        notification.classList.remove('show');
        setTimeout(() => document.body.removeChild(notification), 300);
      }, 3000);
    }

    // Clean up all live updates
    function cleanupLiveUpdates() {
      Object.keys(liveUpdateIntervals).forEach(processId => {
        stopLiveLogUpdates(processId);
      });
    }

    // Cleanup on page unload
    window.addEventListener('beforeunload', cleanupLiveUpdates);

    // Handle window resize for ECharts
    window.addEventListener('resize', () => {
      if (geoHeatmapChart) {
        geoHeatmapChart.resize();
      }
    });

    // Initialize WebSocket connection
    connectWebSocket();
  </script>
</body>

</html>
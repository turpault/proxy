<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YAML Line Highlighting Test</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    .test-container {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .test-title {
      color: #2d3748;
      margin-bottom: 10px;
      font-size: 1.2rem;
    }

    .test-description {
      color: #718096;
      margin-bottom: 15px;
      font-size: 0.9rem;
    }

    .editor-container {
      position: relative;
      margin-bottom: 15px;
    }

    .yaml-editor {
      width: 100%;
      min-height: 200px;
      padding: 1rem;
      border: 1px solid #e2e8f0;
      border-radius: 4px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      resize: vertical;
      background: #f8f9fa;
      color: #2d3748;
    }

    .yaml-editor:focus {
      outline: none;
      border-color: #4299e1;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
    }

    .yaml-editor.invalid {
      border-color: #fc8181;
    }

    .error-line-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      z-index: 10;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
      line-height: 1.5;
      padding: 1rem;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow: hidden;
      background: transparent;
    }

    .error-line-indicator {
      position: absolute;
      background-color: #fed7d7;
      border-left: 3px solid #e53e3e;
      pointer-events: none;
      z-index: 11;
    }

    .validation-result {
      padding: 1rem;
      border-radius: 4px;
      font-weight: 500;
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 200px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .validation-result.success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    .validation-result.error {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    .validation-result.warning {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      color: #856404;
    }

    .test-button {
      background: #4299e1;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-right: 10px;
    }

    .test-button:hover {
      background: #3182ce;
    }

    .test-button:disabled {
      background: #a0aec0;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <h1>ðŸ§ª YAML Line Highlighting Test</h1>
  <p>This page tests the YAML error line highlighting functionality. Enter invalid YAML and click "Validate" to see
    error lines highlighted in red.</p>

  <div class="test-container">
    <div class="test-title">Test Case 1: Missing Colon</div>
    <div class="test-description">This YAML has a missing colon on line 3, which should be highlighted in red.</div>
    <div class="editor-container">
      <textarea class="yaml-editor" id="editor1">processes:
  test-process:
    command "node"
    args: ["app.js"]</textarea>
    </div>
    <button class="test-button" onclick="validateYAML('editor1')">Validate</button>
    <button class="test-button" onclick="clearHighlighting('editor1')">Clear Highlighting</button>
    <div id="result1" class="validation-result" style="display: none;"></div>
  </div>

  <div class="test-container">
    <div class="test-title">Test Case 2: Unclosed Quotes</div>
    <div class="test-description">This YAML has unclosed quotes on line 4, which should be highlighted in red.</div>
    <div class="editor-container">
      <textarea class="yaml-editor" id="editor2">processes:
  test-process:
    command: "node
    args: ["app.js"]</textarea>
    </div>
    <button class="test-button" onclick="validateYAML('editor2')">Validate</button>
    <button class="test-button" onclick="clearHighlighting('editor2')">Clear Highlighting</button>
    <div id="result2" class="validation-result" style="display: none;"></div>
  </div>

  <div class="test-container">
    <div class="test-title">Test Case 3: Inconsistent Indentation</div>
    <div class="test-description">This YAML has inconsistent indentation on line 5, which should be highlighted in red.
    </div>
    <div class="editor-container">
      <textarea class="yaml-editor" id="editor3">processes:
  test-process:
    command: "node"
args: ["app.js"]</textarea>
    </div>
    <button class="test-button" onclick="validateYAML('editor3')">Validate</button>
    <button class="test-button" onclick="clearHighlighting('editor3')">Clear Highlighting</button>
    <div id="result3" class="validation-result" style="display: none;"></div>
  </div>

  <div class="test-container">
    <div class="test-title">Test Case 4: Valid YAML</div>
    <div class="test-description">This YAML is valid and should not show any error highlighting.</div>
    <div class="editor-container">
      <textarea class="yaml-editor" id="editor4">processes:
  test-process:
    command: "node"
    args: ["app.js"]
    env:
      NODE_ENV: "production"</textarea>
    </div>
    <button class="test-button" onclick="validateYAML('editor4')">Validate</button>
    <button class="test-button" onclick="clearHighlighting('editor4')">Clear Highlighting</button>
    <div id="result4" class="validation-result" style="display: none;"></div>
  </div>

  <script>
    // Line highlighting functions (copied from config-editor.js)
    function highlightErrorLine(editor, lineNumber) {
      clearErrorHighlighting(editor);

      if (!lineNumber || lineNumber < 1) return;

      const lines = editor.value.split('\n');
      if (lineNumber > lines.length) return;

      // Create a simple overlay for line highlighting
      const overlay = document.createElement('div');
      overlay.className = 'error-line-overlay';

      // Calculate line height and position
      const lineHeight = 1.5 * 0.9; // line-height * font-size in rem
      const lineHeightPx = lineHeight * 16; // Convert to pixels
      const paddingTop = 16; // 1rem in pixels

      // Calculate the position of the error line
      const errorLineTop = paddingTop + (lineNumber - 1) * lineHeightPx;

      // Create the error line indicator
      const errorIndicator = document.createElement('div');
      errorIndicator.className = 'error-line-indicator';
      errorIndicator.style.cssText = `
                position: absolute;
                top: ${errorLineTop}px;
                left: 0;
                right: 0;
                height: ${lineHeightPx}px;
                background-color: #fed7d7;
                border-left: 3px solid #e53e3e;
                pointer-events: none;
                z-index: 11;
            `;

      // Add warning icon
      const warningIcon = document.createElement('span');
      warningIcon.textContent = 'âš ';
      warningIcon.style.cssText = `
                position: absolute;
                left: -25px;
                top: 0;
                color: #e53e3e;
                font-weight: bold;
                font-size: 0.8rem;
                line-height: ${lineHeightPx}px;
                width: 20px;
                text-align: center;
            `;

      errorIndicator.appendChild(warningIcon);
      overlay.appendChild(errorIndicator);

      // Add the overlay to the editor container
      const container = editor.parentNode;
      container.style.position = 'relative';
      container.appendChild(overlay);

      // Store reference for cleanup
      editor._errorOverlay = overlay;

      // Scroll to the error line
      const scrollTop = errorLineTop - container.offsetHeight / 2;
      editor.scrollTop = Math.max(0, scrollTop);
    }

    function clearErrorHighlighting(editor) {
      if (editor._errorOverlay) {
        editor._errorOverlay.remove();
        delete editor._errorOverlay;
      }
    }

    // Validation function
    async function validateYAML(editorId) {
      const editor = document.getElementById(editorId);
      const resultDiv = document.getElementById('result' + editorId.slice(-1));

      if (!editor) return;

      const content = editor.value;

      // Clear previous results
      resultDiv.style.display = 'none';
      clearErrorHighlighting(editor);
      editor.classList.remove('invalid');

      if (!content || content.trim() === '') {
        resultDiv.textContent = 'Enter YAML content to validate';
        resultDiv.className = 'validation-result warning';
        resultDiv.style.display = 'block';
        return;
      }

      try {
        resultDiv.textContent = 'Validating...';
        resultDiv.className = 'validation-result warning';
        resultDiv.style.display = 'block';

        // For testing purposes, we'll simulate the validation
        // In a real scenario, this would call the actual API
        const response = await fetch('/api/config/processes/validate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ content })
        });

        const data = await response.json();

        if (data.success) {
          resultDiv.textContent = 'âœ… YAML is valid';
          resultDiv.className = 'validation-result success';
        } else {
          let errorMessage = data.error || 'Validation failed';

          if (data.line) {
            errorMessage = `Line ${data.line}: ${errorMessage}`;
            highlightErrorLine(editor, data.line);
            editor.classList.add('invalid');
          }

          if (data.details) {
            errorMessage += `\n\n${data.details}`;
          }

          if (data.suggestions && data.suggestions.length > 0) {
            errorMessage += `\n\nSuggestions:\n${data.suggestions.map(s => `â€¢ ${s}`).join('\n')}`;
          }

          resultDiv.textContent = errorMessage;
          resultDiv.className = 'validation-result error';
        }
      } catch (error) {
        resultDiv.textContent = `Validation error: ${error.message}`;
        resultDiv.className = 'validation-result error';
      }
    }

    function clearHighlighting(editorId) {
      const editor = document.getElementById(editorId);
      const resultDiv = document.getElementById('result' + editorId.slice(-1));

      if (editor) {
        clearErrorHighlighting(editor);
        editor.classList.remove('invalid');
      }

      if (resultDiv) {
        resultDiv.style.display = 'none';
      }
    }
  </script>
</body>
</html>